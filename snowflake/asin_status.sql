WITH forced_active_asins AS (
    SELECT COLUMN1 AS asin FROM VALUES
        ('B07Y8BW5QK'),('B0B6LDJ736'),('B07XBHRHG1'),('B07RT8RRGD'),('B07X6S9JL9'),('B08F6ZV1NS'),
        ('B07X7SPXFN'),('B087PNTYFD'),('B07RQXNL4D'),('B0CVNCH69M'),('B0CVNB2LQC'),('B0CVNCGMCT'),
        ('B0CVNDTPFR'),('B07X9J7R6W'),('B0CW6BSYBX'),('B0CW6CWHW7'),('B0CW6CGN9L'),('B07N2F3JXP'),
        ('B0B6KN6N2D'),('B07XCDFZ79'),('B0B1LDMV23'),('B07XCH3WV1'),('B085BT344B'),('B07XCFX7S2'),
        ('B07N2NC7WJ'),('B0CVNCSMXZ'),('B0CD9Y2SMV'),('B0CVNDXPH4'),('B0CD9DZJ7X'),('B07X6S73KF'),
        ('B07RWXCMJP'),('B08JPFZYHX'),('B0CW6CQZWW'),('B0CD9GBBYQ'),('B07TH7G75W'),('B0B6L744TM'),
        ('B07XVTN3R8'),('B07T9X6MT8'),('B08287BV2Z'),('B08JPCMFV9'),('B07N1XLFXV'),('B0B3GM4596'),
        ('B07X8DD6PK'),('B07N1X7JWP'),('B07X7SLSTS'),('B085BTF4H4'),('B07X7SLBG6'),('B0CW6D7NCV'),
        ('B07S719834'),('B0CVNBDCS4'),('B07X8DD397'),('B0CW6CSXXN'),('B0CD9DW4HT'),('B0CDB18X8B'),
        ('B08JNVJWXZ'),('B0CD9V9295'),('B0DBRDJSTN'),('B0B1LH4GZ5'),('B07TCZ2GNF'),('B0B6L2DKW8'),
        ('B08286NY4J'),('B07XVTMZHM'),('B07T8SSPV8'),('B08JNVG8NJ'),('B07JYWSZ8R'),('B0B6LFR6X2'),
        ('B07X6S4X5K'),('B0CHWCN2CV'),('B07XCFCG9Q'),('B085BTKBZ4'),('B07XBHH5WB'),('B07KWBT5S3'),
        ('B0CVNCGRBL'),('B0CVNDJTYH'),('B0CW6DCT1W'),('B07RWXVVC1'),('B0CVNBLS2D'),('B0D8Q1NRN2'),
        ('B0D8Q4F9NJ'),('B07X6S4KYC'),('B0CW6CPG9K'),('B08JPCNR1N'),('B0CVNCQN84'),('B0CW69X6WF'),
        ('B07TBYH6W5'),('B08286Q42V'),('B07TBXMMF1'),('B07T9WR8LM'),('B08JNV7H95'),('B082H6LG1R'),
        ('B0B6MP2JWV'),('B082H6HGBW'),('B082H699H3'),('B082H6TJ4M'),('B082H6GPQZ'),('B0CZ7DHFTT'),
        ('B0CZ7FNQN7'),('B08JP61H13'),('B082H5S2N3'),('B0B6NX4J9P'),('B082H5DCJ9'),('B082H6BVFG'),
        ('B082H5NGNQ'),('B082H67MND'),('B082H6MLKP'),('B082H64BQC'),('B0CVY13QCG'),('B082H6G784'),
        ('B0CVY2F6Y2'),('B0CVXZSG45'),('B0CZ7H6Z85'),('B0CZ7GHH1C'),('B082H68ZF8'),('B08JNYKHT7'),
        ('B0CVXZKRRF'),('B0CZ7DHFVB'),('B082SPDNLL'),('B0B6N4FW3Q'),('B082SRSS5T'),('B082SS5WXG'),
        ('B082SSD491'),('B08JP74VRZ'),('B0C4ZZBD71'),('B0C4ZM5DFW'),('B0C4ZK2FVW'),('B0C4ZQ3F9N'),
        ('B0C4ZZJN6H'),('B0C4ZV4ZWB'),('B0CFS71KH1'),('B0CVL1VVJW'),('B0C4ZKL781'),('B0CRSMLFT4'),
        ('B0CR4TL4YT'),('B0CFSY3PXW'),('B0B39PRJWF'),('B09CF3R3WX'),('B09CF21FBR'),('B09CF2GXQW'),
        ('B09CF4QWHF'),('B0CDCRCF2Q'),('B07X8KV4VX'),('B0CCYZ2CVQ'),('B08748FHFV'),('B0BRNGKC64'),
        ('B07X8KTGXX'),('B0874BPCB7'),('B0BRND3R56'),('B0BRNFX3CT'),('B091HX3BY9'),('B091HYXNLY'),
        ('B091HVD6B3'),('B091HYP91N'),('B07XDKHPKR'),('B0871LYTP8'),('B0871LHZTY'),('B07XDJDKYH'),
        ('B0871LGY6W'),('B0B7KJWCTH'),('B0874L4YQG'),('B083HFJYJ5'),('B07XDM1TB4'),('B0B25V426Y'),
        ('B091HZXXXM'),('B091HXGYFH')
),
sku_status AS (
    SELECT
        ASIN,
        ALIAS_MARKET_COUNTRY,
        MAX(CASE
                WHEN ALIAS_PRODUCT_STATUS = 'New' THEN 2
                WHEN ALIAS_PRODUCT_STATUS = 'Active' THEN 1
                ELSE 0
            END
        ) AS status_priority
    FROM NETSUITE.NETSUITE.NETSUITE_ITEMS
    WHERE ALIAS_MARKET_COUNTRY = 'US'
      AND ALIAS_SALES_CHANNEL_NAME = 'AMAZON'
      AND ASIN IS NOT NULL
      AND ALIAS_PRODUCT_STATUS IS NOT NULL
      AND ALIAS_PRODUCT_STATUS != 'Missing Status'
    GROUP BY ASIN, ALIAS_MARKET_COUNTRY
),
asin_item_family AS (
    SELECT
        ASIN,
        ALIAS_MARKET_COUNTRY,
        MIN(item_family) AS resolved_item_family
    FROM NETSUITE.NETSUITE.NETSUITE_ITEMS
    WHERE item_family IS NOT NULL
      AND item_family <> ''
      AND ALIAS_MARKET_COUNTRY = 'US'
      AND ALIAS_SALES_CHANNEL_NAME = 'AMAZON'
    GROUP BY ASIN, ALIAS_MARKET_COUNTRY
)
SELECT
    CONCAT(n.ASIN, '-', n.ALIAS_MARKET_COUNTRY) AS ASINxMKP,
    n.ITEM_ID,
    n.SKU,
    n.ASIN,
    n.ALIAS_INTERNAL_ID,
    n.ALIAS_SKU,
    n.NETSUITE_ITEM_NUMBER,
    n.DESCRIPTION,
    n.ALIAS_MARKET_COUNTRY,
    n.ALIAS_SALES_CHANNEL_NAME,
    n.ALIAS_INVENTORY_STATUS,
    CASE
        WHEN f.asin IS NOT NULL THEN 'Active'
        WHEN s.status_priority = 2 THEN 'New'
        WHEN s.status_priority = 1 THEN 'Active'
        ELSE n.ALIAS_PRODUCT_STATUS
    END AS ALIAS_PRODUCT_STATUS,
    COALESCE(a.resolved_item_family, n.item_family, 'Family Missing') AS item_family
FROM NETSUITE.NETSUITE.NETSUITE_ITEMS n
LEFT JOIN sku_status s
    ON n.ASIN = s.ASIN
   AND n.ALIAS_MARKET_COUNTRY = s.ALIAS_MARKET_COUNTRY
LEFT JOIN asin_item_family a
    ON n.ASIN = a.ASIN
   AND n.ALIAS_MARKET_COUNTRY = a.ALIAS_MARKET_COUNTRY
LEFT JOIN forced_active_asins f
    ON n.ASIN = f.asin
WHERE n.ALIAS_MARKET_COUNTRY = 'US'
  AND n.ALIAS_SALES_CHANNEL_NAME = 'AMAZON'
  AND n.ASIN IS NOT NULL
  AND n.ALIAS_PRODUCT_STATUS IS NOT NULL
  AND n.ALIAS_PRODUCT_STATUS != 'Missing Status'
ORDER BY ALIAS_PRODUCT_STATUS ASC;